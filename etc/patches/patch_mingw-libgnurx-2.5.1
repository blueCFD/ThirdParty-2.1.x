diff --git a/lib/regcomp.c b/lib/regcomp.c
index 86195af..a69858e 100644
--- a/lib/regcomp.c
+++ b/lib/regcomp.c
@@ -2561,7 +2561,11 @@ parse_dup_op (bin_tree_t *elem, re_string_t *regexp, re_dfa_t *dfa,
     old_tree = NULL;
 
   if (elem->token.type == SUBEXP)
+#ifdef _WIN64
+    postorder (elem, mark_opt_subexp, (void *) (long long) elem->token.opr.idx);
+#else
     postorder (elem, mark_opt_subexp, (void *) (long) elem->token.opr.idx);
+#endif
 
   tree = create_tree (dfa, elem, NULL,
 		      (end == REG_MISSING ? OP_DUP_ASTERISK : OP_ALT));
@@ -3773,7 +3777,11 @@ create_token_tree (re_dfa_t *dfa, bin_tree_t *left, bin_tree_t *right,
 static reg_errcode_t
 mark_opt_subexp (void *extra, bin_tree_t *node)
 {
+#ifdef _WIN64
+  int idx = (int) (long long) extra;
+#else
   Idx idx = (Idx) (long) extra;
+#endif
   if (node->token.type == SUBEXP && node->token.opr.idx == idx)
     node->token.opt_subexp = 1;
 
diff --git a/lib/regex.c b/lib/regex.c
index e457a78..1e9cee9 100644
--- a/lib/regex.c
+++ b/lib/regex.c
@@ -54,7 +54,7 @@
    #undefs RE_DUP_MAX and sets it to the right value.  */
 #include <limits.h>
 
-#include <regex.h>
+#include "regex.h"
 #include "regex_internal.h"
 
 #include "regex_internal.c"
